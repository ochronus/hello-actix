name: Quality

on:
  push:
    branches:
      - "**"
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  fmt:
    name: rustfmt (formatting)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo build
        uses: Swatinem/rust-cache@v2

      - name: Check formatting
        env:
          CARGO_TERM_COLOR: always
        run: cargo fmt --all -- --check

  taplo:
    name: Taplo (TOML formatting)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo build
        uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true

      - name: Install taplo CLI
        run: cargo install taplo-cli

      - name: Check TOML formatting
        run: taplo fmt --check

  markdownlint:
    name: markdownlint (docs style)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "lts/*"

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Lint Markdown files
        shell: bash
        run: |
          shopt -s globstar nullglob
          files=(**/*.md)
          if [ ${#files[@]} -gt 0 ]; then
            echo "Linting ${#files[@]} Markdown files..."
            markdownlint "${files[@]}"
          else
            echo "No Markdown files found."
          fi

  typos:
    name: typos (spell checking)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo build
        uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true

      - name: Install typos CLI
        run: cargo install typos-cli

      - name: Run typos
        run: typos

  actionlint:
    name: actionlint (workflow lint)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: actionlint
        uses: reviewdog/action-actionlint@v1

  shellcheck:
    name: shellcheck (shell scripts)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Run shellcheck
        uses: ludeeus/action-shellcheck@2.0.0

  shfmt:
    name: shfmt (shell formatting)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup shfmt
        uses: mfinelli/setup-shfmt@v3

      - name: Check shell formatting
        run: shfmt -i 2 -ci -sr -d .

  cargo-audit:
    name: cargo-audit (security advisories)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo build
        uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run cargo audit
        env:
          RUSTSEC_DISABLE_FETCH: false
        run: cargo audit

  cargo-deny:
    name: cargo-deny (advisories, bans, licenses, sources)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo build
        uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true

      - name: Install cargo-deny
        run: cargo install cargo-deny

      - name: Run cargo-deny checks
        run: |
          cargo deny check advisories
          cargo deny check bans

          cargo deny check sources
